#pragma once
#include "Actuator.h"

namespace mel {

    class Motor : public Actuator {

    public:

        //---------------------------------------------------------------------
        // CONSTRUCTOR(S) / DESTRUCTOR(S)
        //---------------------------------------------------------------------

        Motor();
        Motor(std::string name, double kt, double current_limit, double amp_gain, Daq::Ao ao_channel);
        Motor(std::string name, double kt, double current_limit, double amp_gain, Daq::Ao ao_channel, Daq::Do do_channel, EnableMode enable_mode);
        Motor(std::string name, double kt, double current_limit, double amp_gain, Daq::Ao ao_channel, Daq::Do do_channel, EnableMode enable_mode, Daq::Ai ai_channel);

        //---------------------------------------------------------------------
        // PUBLIC FUNCTIONS
        //---------------------------------------------------------------------

        /// Sets the desired torque to be generated at the Motor, converts from torque to current, and calls set_current()
        void set_torque(double new_torque) override; 
        /// Gets the current measured by the current sensor of the current amplifier
        double get_current_sense(); 
        /// Enables the Motor using the associated digital output channel
        void enable() override; 
        /// Disables the Motor using using the associated digital output channel and writes zero to the associated analog output channel
        void disable() override; 
        
        //---------------------------------------------------------------------
        // PUBLIC VARIABLES
        //---------------------------------------------------------------------

        const double kt_; ///< torque constant of the Motor
        const double current_limit_; ///< hard limit to be applied to the desired current of the motor
        const double amp_gain_; ///< the conversion rate between voltage sent to the analog output channel and the current generated by the amplifier [A/V]

        bool has_current_sense_; ///< whether or not the Motor comes with current sensing, i.e., whether or not the ai_channel is provided 

    private:
        
        //---------------------------------------------------------------------
        // PRIVATE FUNCTIONS
        //---------------------------------------------------------------------

        /// Set the desired current to be generated at the Motor, calls limit_current(), converts from current to amplifier voltage command, and sets voltage on associated analog output channel
        void set_current(double new_current);
        /// Applies a saturation at +/- current_limit_ to the desired current
        double saturate_current(double new_current); 

        //---------------------------------------------------------------------
        // PRIVATE VARIABLES
        //---------------------------------------------------------------------

        Daq::Ao ao_channel_; ///< the DAQ analog output channel bound to this Motor (for commanding torque/current)
        Daq::Do do_channel_; ///< the DAQ digital output channel bound to this Motor (for enable/disable)
        Daq::Ai ai_channel_; ///< the DAQ analog input channel bound to this Motor (for current sensing)

        //---------------------------------------------------------------------
        // STATE VARIABLES
        //---------------------------------------------------------------------

        double current_; ///< stores the desired Motor current since the last call to set_current()
        double limited_current_; ///< stores the limited Motor current since the last call to set_current() 
        double current_sense_; ///< store the measured current since the last call to get_current_sense()

        

    };
}